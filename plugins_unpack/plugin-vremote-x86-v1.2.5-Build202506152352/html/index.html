<html>
    <head>
        <script src="../../static/js/vue.js"></script>
        <script src="../../static/js/plugin.js"></script>
        <script src="../../static/js/element.js"></script>
        <link rel="stylesheet" href="../../static/css/plugin.css" type="text/css">
        <link rel="stylesheet" href="../../static/css/element.css">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <div id="app" class="wrapper row" v-loading="loading" :element-loading-text="loading_text">
            <div class="box clearfix">
                <div class="box_block">
                    <div class="clearfix margin_phone col-lg-11 col-lg-offset-1 ">
                        <div  class="line_edit">
                            <span  class="input_tit">开机自启动：</span> 
                            <div  class="input_group">
                                <el-switch @change="set_auto_start" v-model="autostart"></el-switch>
                            </div>
                        </div>
                        <div  class="line_edit">
                            <span  class="input_tit">VNT状态：</span> 
                            <div  class="input_group">
                                <span :class="vntStatusClass">{{ vntStatusMessage }}
                            </div>
                        </div>
                        <div  class="line_edit">
                            <span  class="input_tit">服务状态：</span> 
                            <div  class="input_group">
                                <span :class="statusClass">{{ statusMessage }}
                            </div>
                        </div>
                        <div  class="line_edit">
                            <span  class="input_tit">最后同步时间：</span> 
                            <div  class="input_group">
                                <span :class="syncStatusClass">{{ lastSyncTime }}
                            </div>
                        </div>
                        <div class="line_edit" >
                            <span  class="input_tit">API密钥：</span> 
                            <div  class="input_group">
                                <textarea class="inptText w420" v-model="apiToken"></textarea>
                            </div>
                        </div>
                        <div class="line_edit">
                            <span class="input_tit">启用共享服务：</span>
                            <div class="input_group">
                                <!-- <label class="checkbox">
                                    <input type="checkbox"  v-model="enableProxy"> 
                                    <span></span>
                                    允许本设备对外提供共享网络服务
                                </label><br> -->
                                <label class="checkbox">
                                    <input type="checkbox"  v-model="enableShare"> 
                                    <span></span>
                                    允许本地网络设备访问共享网络服务
                                </label><br>
                                <input type="text" placeholder="请输入共享代码" v-show="enableShare" class="inptText w100" v-model="shareCode">
                            </div>
                        </div>
                        <div class="h20"></div>
                        <div class="line_edit">
                            <div class="input_group">
                                <button type="button" @click="save" :disabled="this.status === 2" class="btn btn_blue btn_confirm">保存配置</button>
                                <button type="button" @click="start" :disabled="this.status === 2" class="btn btn_green btn_confirm">同步并启动</button>
                                <button type="button" @click="stop"  :disabled="this.status === 2" class="btn btn_red btn_confirm">停止服务</button>
                            </div>
                        </div>
                        <div class="h20"></div>
                        <div class="readme col-lg-11 col-xs-12">
                            <span class="note">帮助提示：</span>
                            <div>1、配置“API密钥”方可上报数据，登录App后在设置页面获取。</div>
                            <div>2、推荐本插件配合VNT插件使用，开启VNT后可实现远程管理路由设备。</div>
                            <div>3、共享网络服务运行基于VNT网络，提供设备间相互共享网络的服务。</div>
                            <div>4、使用共享服务需填入网络共享代码，登录App后在共享页面获取。</div>
                        </div>
                        <div class="h40"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script type="module">
        var app = new Vue({
            el: '#app',
            data: {
                mode:"server",
                autostart:false, 
                apiToken:"",
                status: 1,
                statusMessage: "",
                statusClass: "",
                syncStatusClass: "",
                vntStatus: 0,
                vntStatusMessage: "",
                vntStatusClass: "",
                lastSyncTime:"",
                loading:false,
                loading_text: "",
                enableShare:false,
                enableProxy:true,
                shareCode:"",
            },
            created() {
                this.loadInitData();
            },
            methods: {
                loadInitData() {
                    self = this;
                    var payload = {
                        func_name: 'plugin_vremote',
                        action: 'show',
                        param: {TYPE: 'data'}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0 && response.Data) {

                            const data = response.Data;
                            self.lastSyncTime = data.lastSyncTime.trim();
                            if (self.lastSyncTime.includes("(同步失败)")) {
                                self.syncStatusClass = "colorR";
                            } else {
                                self.syncStatusClass = "colorG";
                            }
                            self.status = data.status;
                            self.apiToken = data.apiToken;
                            self.enableProxy = data.enableProxy === "true"?true:false;
                            if (data.status === 1) {
                                self.statusMessage = `正在运行, ${data.runningTime}`;
                                self.statusClass = "colorG";
                            } else if (data.status === 2 ) {
                                self.statusMessage = "正在初始化，请等待...";
                                self.statusClass = "colorR";
                                setTimeout(() => {
                                    self.loadInitData();
                                }, 2000);
                            } else {
                                self.statusMessage = "服务未启动";
                                self.statusClass = "colorR";
                            }
                            self.vntStatus = data.vntStatus;
                            if (data.vntStatus === 1) {
                                self.vntStatusMessage = "VNT运行中，虚拟IP:" + data.virtualIp;
                                self.vntStatusClass = "colorG";
                            } else {
                                self.vntStatusMessage = "VNT未运行";
                                self.vntStatusClass = "colorR";
                            }

                            if (data.autostart === 1) {
                                self.autostart = true;
                            } else {
                                self.autostart = false;
                            }
                            if (data.shareCode) {
                                self.shareCode = data.shareCode;
                                self.enableShare = true;
                            }
                          
                        }
                    });
                },
                set_auto_start() {
                    var payload = {
                        func_name: 'plugin_vremote',
                        action: 'set_auto_start',
                        param: {autostart:this.autostart}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0) {
                            this.$message({message: `VRemote已${this.autostart ? '设为开机自启动' : '取消开机自启动'}！`,type: 'success'});
                        } else {
                            this.autostart = !this.autostart;
                        }
                    });
                },
                save() {

                    self=this;
                    self.loading = true;
                    self.loading_text = "正在保存...";

                    if ( ! self.apiToken) {
                        self.loading = false;
                        self.$message.error('API密钥不能为空！');
                        return;
                    }
                    if (self.enableShare) {
                        if (! self.shareCode) {
                            self.loading = false;
                            self.$message.error('共享代码不能为空！');
                            return;
                        }
                    } else {
                        self.shareCode = "";
                    }

                    var payload = {
                        func_name: 'plugin_vremote',
                        action: 'save',
                        param: {apiToken: self.apiToken, enableProxy: self.enableProxy, shareCode: self.shareCode}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.$message.success('保存配置成功！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`保存配置出错！${response.ErrMsg}`);
                        }
                    });
                },

                start() {
                    if (! self.vntStatus == 1 && self.enableShare ) {
                        self.$message.error('启用共享服务功能时，VNT必须先启动并连接成功！');
                        return;
                    }
                    this.confirmStart();
                },

                confirmStart() {
                    self=this;
                    self.loading = true;
                    self.loading_text = "正在启动...";

                    var payload = {
                        func_name: 'plugin_vremote',
                        action: 'start',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.statusMessage = "正在运行";
                            self.statusClass = "colorG";
                            self.$message.success('VRemote已启动！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`VRemote启动失败！${response.ErrMsg}`);
                        }
                        setTimeout(() => {
                            self.loadInitData();
                        }, 500);
                    });
                },
                stop() {

                    self=this;
                    self.loading = true;
                    self.loading_text = "正在停止...";

                    var payload = {
                        func_name: 'plugin_vremote',
                        action: 'stop',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.statusMessage = "已停止运行";
                            self.statusClass = "colorR";
                            self.$message.success('VRemote已停止运行！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`停止VRemote失败！${response.ErrMsg}`);
                        }
                        setTimeout(() => {
                            self.loadInitData();
                        }, 500);
                    });
                }
            }
        });
    </script>
    <style scoped>
        button:disabled {
            color:#C0C4CC;
            background-color:#EFEFEF;
            cursor:not-allowed
        }
        .el-radio__label {
            font-size: 12px;
        }
    </style>
</html>

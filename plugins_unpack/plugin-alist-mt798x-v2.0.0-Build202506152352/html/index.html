<html>
    <head>
        <script src="../../static/js/vue.js"></script>
        <script src="../../static/js/plugin.js"></script>
        <script src="../../static/js/element.js"></script>
        <link rel="stylesheet" href="../../static/css/plugin.css" type="text/css">
        <link rel="stylesheet" href="../../static/css/element.css">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <div id="app" class="wrapper row" v-loading="loading" :element-loading-text="loading_text">
            <div class="box clearfix">
                <div class="box_block">
                    <div class="clearfix margin_phone col-lg-11 col-lg-offset-1 ">
                        <div  class="line_edit">
                            <span  class="input_tit">开机自启动：</span> 
                            <div  class="input_group">
                                <el-switch @change="set_auto_start" v-model="autostart"  ></el-switch>
                            </div>
                        </div>
                        <div  class="line_edit">
                            <span  class="input_tit">Alist状态：</span> 
                            <div  class="input_group">
                                <span :class="statusClass">{{ statusMessage }}
                            </div>
                        </div>
                        <div class="line_edit">
                            <span class="input_tit">管理面板：</span> 
                            <div class="input_group">
                                <a :href="managerUrl" target="_blank">{{ managerUrl }}</a>
                            </div>
                        </div>
                        <div class="line_edit">
                            <span  class="input_tit" :disabled="true">登录用户名：</span> 
                            <div  class="input_group">
                                <span>admin</span>
                                <!-- <input type="text" class="inptText w200" v-model="username" >  -->
                            </div>
                        </div>
                        <div class="line_edit">
                            <span  class="input_tit">登录密码：</span> 
                            <div  class="input_group">
                                <input type="text" class="inptText w200" v-model="password" > 
                                <button type="submit" @click="setpwd" :disabled="this.status === 2" class="btn btn_green rounded height26 w50">设置密码</button>
                            </div>
                        </div>
                        <div class="line_edit">
                            <div class="input_group">
                                <button type="button" @click="start" :disabled="this.status === 2" class="btn btn_green btn_confirm">启动Alist</button>
                                <button type="button" @click="stop"  :disabled="this.status === 2" class="btn btn_red btn_confirm margin-l-10">停止Alist</button>
                            </div>
                        </div>
                        <div class="h20"></div>
                        <div class="readme col-lg-11 col-xs-12">
                            <span class="note">帮助提示：</span>
                            <!-- <div>2、装载新的存储设备后需要重新启动一下Alist即可识别。</div>
                            <div>3、本机存储设备的本地路径和“系统设置-磁盘管理-文件管理”中设置的路径一致。</div> -->
                            <div>1、请先设置登录密码再启动Alist。</div>
                            <div>2、更多详细使用方法请访问官方网站：<a target="_blank" href="https://alist.nn.ci/zh/">https://alist.nn.ci</a>。</div>
                        </div>
                        <div class="h40"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script type="module">
        var app = new Vue({
            el: '#app',
            props: ["type"],
            data: { 
                autostart: false,
                status: 1,
                statusMessage: "",
                statusClass: "",
                managerUrl: "",
                username: "admin",
                password: "password",
                loading: false,
                loading_text: "正在加载...",
            },
            mounted() {},
            created() {
                this.loadInitData();
            },
            methods: {
                loadInitData() {
                    self=this;
                    var payload = {
                        func_name: 'plugin_alist',
                        action: 'show',
                        param: {TYPE: 'data'}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0 && response.Data) {
                            const data = response.Data;
                            self.autostart = data.autostart === 1;
                            self.status = data.status;
                            if (data.status === 1) {
                                self.statusMessage = `正在运行, ${data.runningTime}`;
                                self.statusClass = "colorG";
                            } else if (data.status === 2 ) {
                                self.statusMessage = "正在初始化，请等待...";
                                self.statusClass = "colorR";
                                setTimeout(() => {
                                    self.loadInitData();
                                }, 2000);
                            } else {
                                self.statusMessage = "已停止运行";
                                self.statusClass = "colorR";
                            }
                            const host = window.location.hostname;
                            self.managerUrl = `http://${window.location.hostname}:${data.webPort}`;
                        }
                    });
                    
                },
                set_auto_start() {
                    var payload = {
                        func_name: 'plugin_alist',
                        action: 'set_auto_start',
                        param: {autostart:this.autostart}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0) {
                            this.$message({message: `Alist${this.autostart ? '设为开机自启动' : '取消开机自启动'}！`,type: 'success'});
                        } else {
                            self.$message.error(`操作失败！${response.ErrMsg}`);
                            this.autostart = !this.autostart;
                        }
                    });
                },
                start(){
                    self=this;
                    
                    self.loading = true;
                    self.loading_text = "loading...";

                    var payload = {
                        func_name: 'plugin_alist',
                        action: 'start',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0) {
                            self.$message({message: `Alist启动成功！`,type: 'success'});
                            this.loadInitData();
                        } else {
                            self.$message.error(`Alist启动失败，${response.ErrMsg}`);
                        }
                        self.loading = false;
                    });
                },

                stop() {
                    self=this;
                    self.loading = true;
                    self.loading_text = "Loading...";

                    var payload = {
                        func_name: 'plugin_alist',
                        action: 'stop',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.$message({message: 'Alist已停止运行!',type: 'success'});
                            self.loadInitData();
                        }
                        self.loading = false;
                    });
                },
                setpwd() {

                    self=this;
                    self.loading = true;
                    self.loading_text = "正在保存...";

                    if (! this.password) {
                        self.loading = false;
                        self.$message.error('密码不能为空！');
                        return;
                    }

                    var payload = {
                        func_name: 'plugin_alist',
                        action: 'setpwd',
                        param: {password:self.password}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.$message.success('保存配置成功！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`保存配置出错！${response.ErrMsg}`);
                        }
                    });
                },
            }
        });
    </script>
</html>

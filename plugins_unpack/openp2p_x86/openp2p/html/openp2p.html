<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="../../static/js/vue.js"></script>
    <script src="../../static/js/plugin.js"></script>
    <script src="../../static/js/element.js"></script>
    <link rel="stylesheet" href="../../static/css/plugin.css" type="text/css">
    <link rel="stylesheet" href="../../static/css/element.css">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
    <div id="app" class="wrapper row" v-loading="loading" :element-loading-text="loading_text">
        <div class="box clearfix">
            <div class="box_block">
                <div class="clearfix margin_phone col-lg-11 col-lg-offset-1 ">
                    <div  class="line_edit">
                        <span  class="input_tit">开机自启动：</span> 
                        <div  class="input_group">
                            <el-switch @change="set_auto_start" v-model="autostart"  ></el-switch>
                        </div>
                    </div>
                    <div  class="line_edit">
                        <span  class="input_tit">OpenP2P状态：</span> 
                        <div  class="input_group">
                            <span :class="statusClass">{{ statusMessage }}</span>
                        </div>
                    </div>
                    <div class="line_edit">
                        <span class="input_tit">访问控制台：</span> 
                        <div class="input_group">
                            <a href="https://console.openp2p.cn/device" target="_blank" style="color: blue; text-decoration: underline;">https://console.openp2p.cn</a>
                        </div>
                    </div>
                    <div  class="line_edit">
                        <span  class="input_tit">唯一标识:</span> 
                        <div  class="input_group">
                            <input type="text" class="inptText" v-model="node" > 
                        </div>
                    </div>
                    <div  class="line_edit">
                        <span  class="input_tit">用户Token:</span> 
                        <div  class="input_group">
                            <input type="text" class="inptText" v-model="token" > 
                        </div>
                    </div>
                    <div class="line_edit">
                        <div class="input_group">
                            <button type="submit" @click="save" :disabled="this.status === 2" class="btn btn_blue btn_confirm">保存配置</button>
                            <button type="button" @click="start" :disabled="this.status === 2" class="btn btn_green btn_confirm">启动OpenP2P</button>
                            <button type="button" @click="stop" :disabled="this.status === 2" class="btn btn_red btn_confirm margin-l-10">停止OpenP2P</button>
                        </div>
                    </div>
                    <div class="h20"></div>
                    <div class="readme col-lg-11 col-xs-12">
                        <span class="note">帮助提示：</span>
                        <div>1、详细说明查看<a target="_blank" href="https://github.com/openp2p-cn/openp2p/blob/master/README-ZH.md">官方帮助文档 </a>。</div>
                        <div>2、从官网获取token后填入保存后即可启动。</div>
                    </div>
                    <div class="h40"></div>
                </div>
            </div>
        </div>
    </div>
            
    <script type="module">
        var app = new Vue({
            el: '#app',
            data: { 
                autostart:false,
                status: 1, 
                statusMessage: "",
                statusClass: "",
                loading:false,
                loading_text: "", 
                node : "",
                token : "",
            },
            created() {
                this.loadInitData();
            },
            methods: {
                loadInitData() {
                    self=this;
                    var payload = {
                        func_name: 'plugin_openp2p',
                        action: 'show',
                        param: {
                            TYPE: 'data'
                        }
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if (response.Result % 10000 == 0 && response.Data) {
                            const data = response.Data;

                            self.status = data.status;
                            if (data.status === 1) {
                                self.statusMessage = "正在运行";
                                self.statusClass = "colorG";
                            } else if (data.status === 2 ) {
                                self.statusMessage = "正在初始化，请等待...";
                                self.statusClass = "colorR";
                                setTimeout(() => {
                                    self.loadInitData();
                                }, 2000);
                            } else {
                                self.statusMessage = "已停止运行";
                                self.statusClass = "colorR";
                            }

                            if (data.autostart === 1) {
                                self.autostart = true;
                            } else {
                                self.autostart = false;
                            }
                                self.node = data.node;
			        self.token = data.token;
                        } else {
                            self.$message.error(`初始化出错，${response.ErrMsg}`);
                        }
                    });
                },
		set_auto_start() {
		    // 检查token是否为空
		    if (!this.token) {
		        this.$message.error('请先设置token并保存后再开启自启动！');
		        this.autostart = false; // 重置开关状态
		        return;
		    }
    
 		   var payload = {
  		      func_name: 'plugin_openp2p',
 		       action: 'set_auto_start',
     		   param: {autostart:this.autostart}
    		};
   		 AjaxPost('/Action/call', payload, (response) => {
        		if (response.Result % 10000 == 0) {
            		this.$message({message: `OpenP2P已${this.autostart ? '设为开机自启动' : '取消开机自启动'}！`,type: 'success'});
        		} else {
            		this.autostart = !this.autostart;
        		}
    		});
		},
		save() {
                    var self = this;
                    self.loading = true;
                    self.loading_text = "正在保存...";

					var payload = {
						func_name: 'plugin_openp2p',
						action: 'save',
						param: {
							token: this.token,node: this.node                                                      
						}
					};
					AjaxPost('/Action/call', payload, (response) => {
						if (response && response.Result % 10000 == 0) {
                            self.loading = false;
                            self.$message.success('保存配置成功！');
						} else {
                            self.loading = false;
			    self.$message.error(`保存配置出错！${response.ErrMsg}`);
						}
					});
				},
                start() {
                    self = this;
                    self.loading = true;
                    self.loading_text = "正在启动...";
                    var payload = {
                        func_name: 'plugin_openp2p',
                        action: 'start',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.statusMessage = "正在运行";
                            self.statusClass = "colorG";
                            self.$message.success('OpenP2P已启动！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`启动OpenP2P失败！${response.ErrMsg}`);
                        }
                        setTimeout(() => {
                            self.loadInitData();
                        }, 500);
                    });
                },
                stop() {
                    self = this;
                    self.loading = true;
                    self.loading_text = "正在停止...";

                    var payload = {
                        func_name: 'plugin_openp2p',
                        action: 'stop',
                        param: {}
                    };
                    AjaxPost('/Action/call', payload, (response) => {
                        if(response.Result % 10000 == 0) {
                            self.loading = false;
                            self.statusMessage = "已停止运行";
                            self.statusClass = "colorR";
                            self.$message.success('OpenP2P已停止运行！');
                        }
                        else {
                            self.loading = false;
                            self.$message.error(`停止OpenP2P失败！${response.ErrMsg}`);
                        }
                        setTimeout(() => {
                            self.loadInitData();
                        }, 1000);
                    });
                },
            }
        });
    </script>
</body>
</html>

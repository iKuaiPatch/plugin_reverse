<html>
<head>
	<title>Docker Console</title>
	<link rel="stylesheet" href="xterm.css" />
	<script src="xterm.js"></script>
	<style> 
		body {
			padding: 0;
			margin: 0;
			background-color: #000;
		}
		.xterm-viewport{
			visibility:hidden;
		}
		.xterm.fullscreen{
			position:fixed;top:0;bottom:0;left:0;right:0;width:auto;height:auto;z-index:255
		}
	</style>
</head>
<body>
    <div id="container-terminal"></div>
    
    <script type="text/javascript">
		var term, websocket, containerId = '';
		var is_get_hostname = false;
		
        function getQueryVar(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0; i<vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                     return pair[1];
                }
            }
            
            return false;
        }

		function ResizePty(t, sock) {
			var style_width = t._core._renderService._renderer.dimensions.actualCellWidth;
			var style_height = t._core._renderService._renderer.dimensions.actualCellHeight;
			var cols = parseInt(window.innerWidth/style_width, 10) -1;
			var rows = parseInt(window.innerHeight/style_height, 10);
			if (t.cols != cols || t.rows != rows) {
				t.resize(cols, rows);
				sock.send('resize:' + cols + ' ' + rows);
				console.log('resize:', cols, rows, style_width, style_height);
			};
		};

		function SetTitle(s) {
			if (s.substr(0,4) == "\x1b\x5d\x30\x3b") {
				var m = s.match("^\x1b\x5d\x30\x3b(.+)\x2f\x07");
				if (m) {
					is_get_hostname = true;
					document.title = m[1];
					console.log("set title:",m[1]);
				}
			}
		}

		containerId = getQueryVar('id');
		if (!containerId) {
			containerId = prompt('Container ID');
		}
		let cosnoleProtocol = 'ws';
		if(location.protocol == 'http:'){
			cosnoleProtocol = 'ws';
		}else if(location.protocol == 'https:'){
			cosnoleProtocol = 'wss';
		}
		websocket = new WebSocket(cosnoleProtocol + "://" + window.location.hostname + ":" + window.location.port + "/Action/dkconsole?" + "id=" + containerId);
		websocket.onopen = function(evt) {
			term = new Terminal({
				//fontSize: 15,
				cursorStyle: 'underline', //光标样式
				cursorBlink: true // 光标闪烁
			});
			term.open(document.getElementById('container-terminal'));
			ResizePty(term, websocket);

			window.addEventListener("resize", function () {
				ResizePty(term, websocket);
			});

			term.onData(function(data) {
				websocket.send('data:' + data);
			});

			websocket.onmessage = function(evt) {
				term.write(evt.data);
				if (is_get_hostname == false) {
					SetTitle(evt.data);
				}
			}

			websocket.onclose = function(evt) {
				console.log(evt.reason);
				if (evt.reason)	{
					term.write("\n\n"+evt.reason);
				} else {
					term.write("\n\nSession terminated");
				}
				
			}

			websocket.onerror = function(evt) {
				console.log(evt)
			}
		}
    </script>
    </body>
</html>

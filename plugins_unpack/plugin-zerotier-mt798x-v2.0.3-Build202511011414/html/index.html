<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <script src="../../static/js/vue.js"></script>
    <script src="../../static/js/plugin.js"></script>
    <script src="../../static/js/element.js"></script>
    <link rel="stylesheet" href="../../static/css/plugin.css" type="text/css" />
    <link rel="stylesheet" href="../../static/css/element.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
  <body>
    <div id="app" class="wrapper row" v-loading="loading" :element-loading-text="loading_text">
      <div class="box clearfix">
        <div class="box_block">
          <div class="clearfix margin_phone col-lg-11 col-lg-offset-1">
            <div class="line_edit">
              <span class="input_tit">开机自启动：</span>
              <div class="input_group">
                <el-switch @change="set_auto_start" v-model="autostart"></el-switch>
              </div>
            </div>
            <div class="line_edit">
              <span class="input_tit">运行状态：</span>
              <div class="input_group">
                <span :class="statusClass">{{ statusMessage }}</span>
              </div>
            </div>
            <div class="line_edit">
              <span class="input_tit">连接状态：</span>
              <div class="input_group">{{ linkStatus }}</div>
            </div>
            <div class="line_edit">
              <span class="input_tit">网络类型：</span>
              <div class="input_group">{{ networkType }}</div>
            </div>
            <div class="line_edit">
              <span class="input_tit">网络名称：</span>
              <div class="input_group">{{ networkName }}</div>
            </div>
            <!-- <div  class="line_edit">
                  <span  class="input_tit">硬件地址：</span> 
                  <div  class="input_group">
                      {{ dev_mac }}
                  </div>
                </div> -->
            <div class="line_edit">
              <span class="input_tit">虚拟IP地址：</span>
              <div class="input_group">{{ virtualIp }}</div>
            </div>
            <div class="line_edit">
              <span class="input_tit">网络ID：</span>
              <div class="input_group">
                <input type="text" placeholder="请输入网络ID" class="inptText" v-model="networkId" />
              </div>
            </div>
            <div class="line_edit">
              <div class="input_tit">
                <div>自定义Planet：</div>
                <div class="colorG">(可选)</div>
              </div>
              <div class="input_P">
                <span class="colorG" >若要使用自建服务器，可在下方上传自定义Planet配置文件。 </span>
                <el-button type="text" @click="removePlanet" style="padding-top: 0px;">恢复默认</el-button>
              </div>
              <br class="h5" />
              <div class="input_group">
                <div class="type_file file_W tl margin-r-5 fl">
                  <input type="text" id="fileName" class="inptText textfield rounded" />
                  <input
                    name=""
                    type="submit"
                    class="btn btn_blue rounded type_file_button height26 fl"
                    value="选择文件"
                  />
                  <input
                    type="file"
                    id="fileUploads"
                    class="type_file_file fileField"
                    onchange="document.getElementById('fileName').value = this.files[0].name;"
                  />
                </div>
              </div>
              <div class="input_P" style="padding-top: 0px">
                <input value="确认上传" @click="uploadPlanet" type="button" class="btn btn_green rounded height26" />
              </div>
            </div>
            <div class="h10"></div>
            <div class="line_edit">
              <div class="input_group">
                <button type="submit" @click="save" :disabled="this.status === 2" class="btn btn_blue btn_confirm">
                  保存配置
                </button>
                <button type="button" @click="start" :disabled="this.status === 2" class="btn btn_green btn_confirm margin-l-10">
                  连接网络
                </button>
                <button type="button" @click="stop" :disabled="this.status === 2" class="btn btn_red btn_confirm">
                  断开连接
                </button>
              </div>
            </div>
            <div class="h20"></div>
            <div class="readme col-lg-11 col-xs-12">
              <span class="note">帮助提示：</span>
              <div>1、连接前请先输入网络ID并保持配置，详细教程查看<a target="_blank" href="https://docs.zerotier.com/">官方帮助文档 </a>。</div>
              <div>2、若要使用自建服务器，可上传自定义Planet配置文件。</div>
            </div>
            
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      var app = new Vue({
        el: "#app",
        data: {
          autostart: false,
          status: 0,
          statusMessage: "",
          statusClass: "",
          networkId: "",
          networkName: "未知",
          linkStatus: "未连接",
          networkType: "未知",
          virtualIp: "未获取",
          loading: false,
          loading_text: "",
        },
        created() {
          this.loadInitData();
        },
        methods: {
          loadInitData() {
            self = this;
            var payload = {
              func_name: "plugin_zerotier",
              action: "show",
              param: { TYPE: "data" },
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0 && response.Data) {
                const data = response.Data;

                self.status = data.status;
                if (data.autostart === 1) {
                  self.autostart = true;
                } else {
                  self.autostart = false;
                }
                if (data.status === 1) {
                  self.statusMessage = `正在运行, ${data.runningTime}`;
                  self.statusClass = "colorG";
                } else if (data.status === 2) {
                  self.statusMessage = "正在初始化，请等待...";
                  self.statusClass = "colorR";
                  setTimeout(() => {
                    self.loadInitData();
                  }, 2000);
                } else {
                  self.statusMessage = "已停止运行";
                  self.statusClass = "colorR";
                }

                self.networkId = data.networkId;
                self.networkName = data.networkName;
                self.linkStatus = data.linkStatus;
                self.networkType = data.networkType;
                self.virtualIp = data.virtualIp;
              }
            });
          },
          set_auto_start() {
            var payload = {
              func_name: "plugin_zerotier",
              action: "set_auto_start",
              param: { autostart: this.autostart },
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                this.$message({
                  message: `Zerotier已${this.autostart ? "设为开机自启动" : "取消开机自启动"}！`,
                  type: "success",
                });
              } else {
                this.autostart = !this.autostart;
              }
            });
          },

          validateInput(input, regex) {
            return regex.test(input);
          },

          save() {

            if (!/^[a-zA-Z0-9\.]+(:[0-9]+)?$/.test(self.networkId)) {
              self.$message.error("网络ID格式错误！");
              return;
            }

            self = this;
            self.loading = true;
            self.loading_text = "正在保存...";

            var payload = {
              func_name: "plugin_zerotier",
              action: "save",
              param: {
                networkId: self.networkId.trim(),
              },
            };

            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                self.loading = false;
                self.$message.success("保存配置成功！");
              } else {
                self.loading = false;
                self.$message.error(`保存配置出错！${response.ErrMsg}`);
              }
            });
          },
          start() {
            self = this;
            self.loading = true;
            self.loading_text = "正在启动...";
            var payload = {
              func_name: "plugin_zerotier",
              action: "start",
              param: {},
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                self.loading = false;
                self.statusMessage = "正在运行";
                self.statusClass = "colorG";
                self.$message.success("Zerotier已启动！");
              } else {
                self.loading = false;
                self.$message.error(`启动Zerotier失败！${response.ErrMsg}`);
              }
              setTimeout(() => {
                self.loadInitData();
              }, 500);
            });
          },

          stop() {
            self = this;
            self.loading = true;
            self.loading_text = "正在停止...";

            var payload = {
              func_name: "plugin_zerotier",
              action: "stop",
              param: {},
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                self.loading = false;
                self.statusMessage = "已停止运行";
                self.statusClass = "colorR";
                self.$message.success("Zerotier已停止运行！");
              } else {
                self.loading = false;
                self.$message.error(`停止Zerotier失败！${response.ErrMsg}`);
              }
              setTimeout(() => {
                self.loadInitData();
              }, 500);
            });
          },

          removePlanet() {
            self = this;
            self.loading = true;
            self.loading_text = "正在删除Planet...";

            var payload = {
              func_name: "plugin_zerotier",
              action: "remove_planet",
              param: {},
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                self.loading = false;
                self.$message.success("Planet已删除！");
              } else {
                self.loading = false;
                self.$message.error(`删除Planet失败！${response.ErrMsg}`);
              }
              setTimeout(() => {
                self.loadInitData();
              }, 500);
            });
          },

          uploadPlanet() {
            self=this;
            self.loading = true;
            self.loading_text = "上传Planet文件中...";

            var fileInput = document.getElementById("fileUpload");
            var file = fileInput.files[0];

            if (!file) {
              self.$message.error("请选择Planet 文件")
              return;
            }

            var formData = new FormData();
            formData.append("file", file);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/Action/upload", true);
            xhr.onload = function () {
              if (xhr.status == 200) {
                app.apply_planet();
              } else {
                self.loading = false;
                self.$message.error('上传Planet文件失败！');
              }
            };
            xhr.onerror = function () {
              self.loading = false;
              self.$message.error('网络错误，上传失败');
            };
            xhr.send(formData);
          },

          apply_planet() {
            self = this;
            self.loading_text = "上传成功！正在应用配置...."
            var payload = {
              func_name: "plugin_zerotier",
              action: "upload_planet",
              param: {},
            };
            AjaxPost("/Action/call", payload, (response) => {
              if (response.Result % 10000 == 0) {
                self.loading = false;
                self.$message.success("自定义Planet 上传并配置成功！");
                document.getElementById('fileName').value = '';
                self.loadInitData(); 
              } else {
                self.loading = false;
                self.$message.error(`配置失败！${response.ErrMsg}`);
              }
            });
          },
        },
      });
    </script>
  </body>
</html>
